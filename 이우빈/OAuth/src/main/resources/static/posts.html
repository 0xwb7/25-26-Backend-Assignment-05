<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <link rel="stylesheet" href="/css/app.css">
    <title>게시글 목록</title>
</head>
<body>
<h1>게시글</h1>

<nav>
    <a href="/index.html">홈</a> |
    <a href="/login.html">로그인</a> |
    <a href="/myPage.html">내 정보</a> |
    <a href="/createPost.html">글쓰기</a>
    <button id="logout" style="float:right">로그아웃</button>
</nav>

<section>
    <h3>목록</h3>
    <div id="list">불러오는 중…</div>
</section>

<script src="/js/api.js"></script>
<script>
    document.getElementById('logout').onclick = AppAPI.logoutAndGoHome;

    (async function load() {
        if (!AppAPI.getAccessToken()) {
            const r = await fetch('/auth/refresh', { method: 'POST', credentials: 'include' });
            if (r.ok) {
                const j = await r.json();
                AppAPI.setAccessToken(j.accessToken || null);
            }
        }

        const res = await AppAPI.api('/posts', { method: 'GET' });

        const list = document.getElementById('list');
        if (res.status !== 200 || !Array.isArray(res.json)) {
            list.textContent = '목록을 불러오지 못했습니다.';
            return;
        }
        if (res.json.length === 0) {
            list.textContent = '게시글이 없습니다.';
            return;
        }

        const frag = document.createDocumentFragment();
        for (const p of res.json) {
            const div = document.createElement('div');
            div.style.margin = '8px 0';
            const id = p.postId ?? p.id;
            div.innerHTML = `
        <a href="/post.html?id=${encodeURIComponent(id)}"><b>${escapeHtml(p.title)}</b></a>
        <div style="font-size:12px;color:#666">작성자: ${escapeHtml(p.authorName ?? '')}</div>
      `;
            frag.appendChild(div);
        }
        list.innerHTML = '';
        list.appendChild(frag);
    })();

    function escapeHtml(s) {
        return s == null ? '' : s.replace(/[&<>"']/g, c => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        })[c]);
    }
</script>
</body>
</html>
